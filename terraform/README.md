# Blind Charging API - Terraform

This directory contains the Terraform configuration to deploy the Blind Charging API on Azure.

## Quick start

Follow these steps to deploy the Blind Charging API.

### 1. Create Azure subscription

You will need the subscription ID for step (2), so first set this up through Azure.

### 2. Log in to Azure via the CLI

If you don't have the Azure CLI installed yet, [set that up](https://learn.microsoft.com/en-us/cli/azure/).

Then, log in with the tenant you used in step (1):

```zsh
# If necessary, set the environment to use GovCloud.
 > az cloud set -n AzureUSGovernment
# Then complete the login flow.
 > az login
```

### 3. Set project variables

Make a new `<my-new-env>.tfvars` file with the relevant values.
(See `./vars.tf` for more information on the available options.)
The Harvard team will need to provision some of these values.

**NOTE** See [the CLI `provision` command](../cmd/README.md) for help generating this file.

### 4. Run Terraform

If you don't have the Terraform CLI installed yet, [set that up](https://developer.hashicorp.com/terraform/install).

First run:

```zsh
terraform init
```

To initialize the Terraform environment. Then, to deploy the application, run:

```zsh
terraform plan -var-file="<my-new-env>.tfvars" -out="deploy.tfplan"
terraform apply "deploy.tfplan"
```

### 5. Making subsequent updates / changes

You will generally not need to re-run the `init` command.

Keep the `.tfstate` file generated by the first `apply` command for future use.
In subsequent `apply` runs, if you move or rename the state file, you can reuse it with the `-state="<my-state>.tfstate"` parameter.

So an example update is:

```zsh
terraform plan -var-file="<my-new-env>.tfvars" -state="<my-state>.tfstate" -out="update.tfplan"
terraform apply -state="<my-state>.tfstate" -out="update.tfplan"
```

#### Applying new docker image updates

**NOTE** These instructions are liable to change in the future as we automate more deployment steps!

Updates that affect the running service such as `app_config` changes or Docker image updates are _not_ rolled out automatically at this time.

You will need to restart the container app revision in order to pick up these new changes.

You can do this either in the Azure Portal UI or on the command line.

The CLI steps (assuming you have `az` and `jq` installed) are:

```zsh
RBC_CONTAINER_APP_NAME=`az containerapp list | jq --raw-output '.[0].name'`
RBC_CONTAINER_APP_ACTIVE_REVISION_NAME=`az containerapp revision list -n "$RBC_CONTAINER_APP_NAME" -g RaceBlindCharging | jq --raw-output '.[0].name'`
az containerapp revision restart --revision "$RBC_CONTAINER_APP_ACTIVE_REVISION_NAME" -g RaceBlindCharging
```
